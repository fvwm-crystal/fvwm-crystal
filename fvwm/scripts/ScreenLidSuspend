#!/usr/bin/env bash
# On laptop, suspend hybrid from components/functions/Exit

# be sure no old instance are runninng for the same fvwm parent or with no fvwm parent:
# It should work on linux and freebsd
PFExec="${FVWM_SYSTEMDIR}/scripts/DesktopCheckParent"
ParentFvwm=$(${PFExec})
for i in $(pgrep -f ScreenLidSuspend) ; do
	if [[ $$ -ne ${i} ]] ; then
		if [[ ${ParentFvwm} -eq $(${PFExec} ${i}) ]] || [[ "nofvwmp" == "$(${PFExec} ${i})" ]] ; then
			kill ${i}
		fi
	fi
done

# Be sure it don't attach to init at Quit
cleanup() {
	echo cleanup $0
	exit 0
}
trap cleanup INT QUIT TERM

if [[ $1 == *pm* ]] ; then
	PMV=pm
elif [[ $1 == *sysctl ]] ; then
	PMV=sys
elif [[ $1 == *loginctl ]] ; then
	PMV=log
fi

while :
do
	# exit if $$ get attached to init at fvwmQuit
	if [[ "nofvwmp" == "$(${PFExec} $$)" ]] ; then
		cleanup
	fi

	sleep 5
	grep -q closed /proc/acpi/button/lid/*/state
	if [ $? = 0 ]; then
		case "${PMV}" in
			pm)
				sudo "${PMV}"
				;;
			log)
				sudo "${PMV}" hybrid-sleep
				;;
			sys)
				sudo "${PMV}" hybrid-sleep -i
				;;
			*)
				exit 1
				;;
		esac
	fi
done
